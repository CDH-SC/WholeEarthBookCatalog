<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<!-- iron ajax -->
<!-- app route -->
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">

<!-- Inserts/removes paper input fields -->

<dom-module id="frag-advanced-search">
    <template>
        <style>
            #dialog {
                width: 60%;
            }

            .col-inputs {
                display: flex;
                flex-direction: row;
                justify-content: space-around;
            }

            .input-adv {
                width: 50rem;
                padding-right: 2rem;
                padding-left: 2rem;
            }

            .remove {
                background-color: red;
                color: white;
            }
            .add {
                background-color: green;
                color: white;
            }
            .search-submit {
                background-color: blue;
                color: white;
            }
        </style>

        <paper-dialog id="dialog">
            <h2>Advanced Search</h2>
            <paper-dialog-scrollable>
                <template is="dom-repeat" items="[[numFieldsArray]]">
                    <div class="col-inputs">
                        <paper-input class="input-adv" label="Search Criteria" value="{{item.value}}" placeholder="search criteria" id="searchField_{{item}}"></paper-input>
                        <paper-dropdown-menu label="search type" on-value-changed="_update_available" data-args="{{item}}">
                            <paper-listbox slot="dropdown-content">
                                <template is="dom-repeat" items="[[avaliableChoices]]" as="choice">
                                    <paper-item disabled="[[choice.selected]]">
                                        {{choice.value}}
                                    </paper-item>
                                </template>
                            </paper-listbox>
                        </paper-dropdown-menu>
                        <paper-button class="remove" on-click="_remove" remove-item="{{item}}" disabled="{{item.first}}">
                            Remove
                        </paper-button>
                    </div>
                </template>
                <paper-button class="add" on-click="_increment_num_fields" disabled="{{addMoreDisabled}}">Add Field</paper-button>
                <paper-button class="search-submit" on-click="_goto_search">Search</paper-button>
            </paper-dialog-scrollable>
        </paper-dialog>
        
    </template>

    <script>
        class fragAdvancedSearch extends Polymer.Element {
            static get is() {
                return 'frag-advanced-search'; 
            }
            static get properties() {
                // Startout with 3 fields, Keyword, author, title
                return {
                    numInputs: Number,
                    addMoreDisabled: Boolean,
                    numFieldsArray: {
                        type: Array,
                        value: [{index: 0, value: "", searchType: "", first: true },
                        {index: 1, value: "", searchType: ""},
                        {index: 2, value: "", searchType: ""},
                    ]
                    },
                    avaliableChoices: {
                        type: Array,
                        value: [ { value: "keyword", selected: false},
                        { value: "author", selected: false},
                        { value: "title", selected: false},
                        { value: "publisher", selected: false},
                        { value: "year", selected: false} ]
                    },
                    currentlyUsedChoices: {
                        type: Array,
                    }
                }
            }

            constructor() {
                super();
            }

            _increment_num_fields() {
                this.push("numFieldsArray", {index:this.numFieldsArray[this.numFieldsArray.length - 1] + 1, value: "", searchType: ""});
                if (this.numFieldsArray.length >= this.avaliableChoices.length) {
                    this.set("addMoreDisabled", true);
                }
            }

            _update_available(event) {
                // we want to get the last searchType value at the index, set that value in selected choices to
                // false. Update the new value in avliable choices to true, set searchType value at index to new
                // search type.

                var itemObj = event.path[0].dataArgs;

                for (var i = 0; i < this.avaliableChoices.length; i++) {
                    if (this.avaliableChoices[i].value === itemObj.searchType) {
                        this.set("avaliableChoices."+ i +".selected",false);
                    }

                    if (this.avaliableChoices[i].value === event.detail.value) {
                        this.avaliableChoices[i].selected = true;
                        this.set("avaliableChoices." + i, {value: event.detail.value, selected: true});
                        this.set("numFieldsArray." + itemObj.index + "searchType", event.detail.value);                       
                    }
                }
            }
            _remove(event) {
                this.splice("numFieldsArray", event.path[0].removeItem, 1);

                if(this.numFieldsArray.length < this.avaliableChoices.length) {
                    this.set("addMoreDisabled", false);
                }
            }

            _goto_search() {
                this.dispatchEvent(new CustomEvent('update-search', {
                    bubbles: true, composed: true, detail: {
                    search: { data: this.numFieldsArray },
                }}));

                console.log(this.search);

                console.log("going");
                
                // TODO: this needs to be updated to include more information. Ok for now.
                this.set("route.path", "/book-results/" + this.numFieldsArray[0].value);
            }

        } window.customElements.define(fragAdvancedSearch.is, fragAdvancedSearch);
    </script>
</dom-module>