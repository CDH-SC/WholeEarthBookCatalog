<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<!-- iron ajax -->
<!-- app route -->
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<!-- Inserts/removes paper input fields -->

<dom-module id="frag-advanced-search">
    <template>
        <style>
            #dialog {
                width: 60%;
            }

            .col-inputs {
                display: flex;
                flex-direction: row;
                justify-content: space-around;
            }

            .input-adv {
                width: 50rem;
                padding-right: 2rem;
                padding-left: 2rem;
            }

            .remove {
                background-color: red;
                color: white;
            }
            .add {
                background-color: green;
                color: white;
            }
            .search-submit {
                background-color: blue;
                color: white;
            }

            paper-dialog paper-dialog-scrollable {
                --paper-dialog-scrollable: {
                    box-sizing: border-box;
                    width: 80%;
                    height: 640px;
                }
            }
  
        </style>

        <iron-ajax
            method="POST"
            id="saveq"
            url="/api/update_saved_content"
            handle-as="json"
            on-response="_handleRecentSearch"
            content-type="application/json"
            debounce-duration="300">
        </iron-ajax>

        <paper-dialog id="dialog">
            <h2>Advanced Search</h2>
            <paper-dialog-scrollable>
                <template is="dom-repeat" items="[[numFieldsArray]]">
                    <div class="col-inputs">
                        <paper-dropdown-menu label="search type" on-value-changed="_update_num_fields" data-args="{{item}}">
                            <paper-listbox slot="dropdown-content" selected="{{item.searchTypeID}}">
                                <paper-item></paper-item>
                                <template is="dom-repeat" items="[[avaliableChoices]]" as="choice">
                                    <paper-item>
                                        {{choice.field}}
                                    </paper-item>
                                </template>
                            </paper-listbox>
                        </paper-dropdown-menu>
                        <paper-button class="remove" on-click="_remove" remove-item="{{item}}" disabled="{{item.first}}">
                            Remove
                        </paper-button>
                    </div>
                    <!-- change to check if author -->
                    <template is="dom-if" if="{{_isAuthor(item.searchType)}}">
                        <paper-input label="first name" value="{{item.value.fname}}"></paper-input>
                        <paper-input label="last name" value="{{item.value.lname}}"></paper-input>
                    </template>

                    <template is="dom-if" if="{{_isPub(item.searchType)}}">
                        <paper-input label="name" value="{{item.value.name}}"></paper-input>
                    </template>

                    <template is="dom-if" if="{{_isEdition(item.searchType)}}">
                        <paper-input label="name" value="{{item.value.name}}"></paper-input>
                        <paper-input label="year" value="{{item.value.year}}"></paper-input>
                    </template>

                    <template is="dom-if" if="{{_isLocation(item.searchType)}}">
                        <paper-input label="Location" placeholder="Location" value="{{item.value.place}}"></paper-input>
                    </template>

                    <template is="dom-if" if="{{_isDegree(item.searchType)}}">
                        <paper-dropdown-menu label="search type">
                            <paper-listbox slot="dropdown-content" selected="{{item.value.degree}}">
                                <paper-item></paper-item>
                                <paper-item>1</paper-item>
                                <paper-item>2</paper-item>
                                <paper-item>3</paper-item>
                                <paper-item>4</paper-item>
                                <paper-item>5</paper-item>
                                <paper-item>6</paper-item>
                                <paper-item>7</paper-item>
                            </paper-listbox>
                        </paper-dropdown-menu>
                    </template>
                </template>

                <template is="dom-if" if="{{_invalidSearch}}">
                    <p>Your search was invalid. Check over your fields and make sure everything has a title and author</p>
                </template>

                <paper-button class="add" on-click="_increment_num_fields" disabled="{{addMoreDisabled}}">Add Field</paper-button>
                <paper-button class="search-submit" on-click="_goto_search">Search</paper-button>
            </paper-dialog-scrollable>
        </paper-dialog>
        
    </template>

    <script>
        class fragAdvancedSearch extends Polymer.Element {
            static get is() {
                return 'frag-advanced-search'; 
            }
            static get properties() {
                // Startout with 3 fields, Keyword, author, title
                return {
                    user:  {
                        type: Object,
                        notify: true
                    },
                    numInputs: Number,
                    addMoreDisabled: Boolean,
                    
                    /*
                     * Model:
                     * [ 
                     *  { id, searchTypeID, searchType, Value }
                     * ]
                     */
                    numFieldsArray: {
                        type: Array,
                        value: [ {id: 0, searchTypeID: -1, searchType: "", value: {}} ]
                    },
                    avaliableChoices: {
                        type: Array,
                        value: [{ field: "author", subFields: [ { value:"first name", type: "String" }, { value:"last name", type:"String" }]}, 
                                { field: "publisher", subFields: [{ value: "name", type: "String" }]}, 
                                { field: "edition", subFields: [{value: "title", type: "String"},{value: "year", type: "Number"}]}, 
                                { field: "location", subFields: [{value: "name", type: "String"}]}, 
                                { field: "degree", subFields: [{value: "degree", type: "Dropdown"}]}]
                    },
                    _highestIDUsed: {
                        type: Number,
                        value: 0
                    },
                    _invalidSearch: { 
                        type: Boolean,
                        value: false
                    },
                    _degreeLimit: {
                        type: Number,
                        value: 7
                    },
                    _inputLimit: {
                        type: Number,
                        value: 10
                    }
                }
            }

            constructor() {
                super();
            }

            ready() {
                super.ready();
            }

            _getItems(item) {
                // To accomdate for the blank
                var index = item.searchTypeID - 1;
                
                
                return this.avaliableChoices[index].subFields;
            }

            _isAuthor(type) {
                return type === "author";
            }

            _isDegree(type) {
                return type === "degree";
            }

            _isLocation(type) {
                return type === "location";
            }

            _isPub(type) {
                return type === "publisher";
            }

            _isEdition(type) {
                return type === "edition";
            }

            _checkSearchType(item) {
                if(item === "author") {
                    return true;
                }
                else {
                    return false;
                }
            }

            _increment_num_fields() {
                this._highestIDUsed += 1;
                this.push("numFieldsArray", {id: this._highestIDUsed, value: "", searchTypeID: -1, searchType: "", value: {}});
                if (this.numFieldsArray.length >= this._inputLimit) {
                    this.set("addMoreDisabled", true);
                }
            }

            _update_num_fields(event) {
                var itemObj = event.path[0].dataArgs;
                this.numFieldsArray.some(function(item, ind) {
                    if(item.id === itemObj.id) {
                        this.set("numFieldsArray." + ind + ".searchType", event.detail.value);                       
                        return;
                    }
                }.bind(this))
            }

            _remove(event) {
                this.numFieldsArray.some(function(item, ind) {
                    if(item.id === event.path[0].removeItem.id) {
                        this.splice("numFieldsArray", ind, 1);
                        return;
                    }
                }.bind(this))
                
                if(this.numFieldsArray.length < this._inputLimit) {
                    this.set("addMoreDisabled", false);
                }
            }

            _validate() {
                if (this.numFieldsArray.length <= 0) {
                    
                    this.set("_invalidSearch", true);
                    this._bindTimeout();
                }
                
                else if (this.numFieldsArray.length > 0) {
                    var oneNonEmpty;
                    for (var i = 0; i < this.numFieldsArray.length; i++) {
                        // If we have a value we need a search type. All other combos we ignore in body
                        
                        if(this.numFieldsArray[i].searchType === "" && this.numFieldsArray[i].value !== "") {
                            
                            this.set("_invalidSearch", true);
                            this._bindTimeout();
                        }
                        if(this.numFieldsArray[i].searchType !== "" && this.numFieldsArray[i].value !== "") {
                            oneNonEmpty = true;
                        }
                    }
                    if(!oneNonEmpty) {
                        this.set("_invalidSearch", true);
                        this._bindTimeout();
                    }
                    else {
                        this.set("_invalidSearch", false);
                    }
                }

                else {
                    this.set("_invalidSearch", false);
                }
            }

            _bindTimeout() {
                setTimeout(function() {
                    this.set('_invalidSearch', false);
                }.bind(this), 5000);                
            }

            _unsetInvalid() {
                this.set("_invalidSearch", false);
            }


            _goto_search() {
                console.log(this.numFieldsArray);
                this._validate();

                if(!this._invalidSearch) {
                    var sObj = { 
                            advanced: true,
                            basic_query: "",
                            terms: this.numFieldsArray,
                            limit: 25
                    };

                    this.$.saveq.body = {
                        _id: this.user.id,
                        keyword:"recent_searches",
                        content: sObj
                    }

                    this.$.saveq.generateRequest();

                    this.dispatchEvent(new CustomEvent('update-search', {
                        bubbles: true, composed: true, detail: sObj
                    }));
                
                    // TODO: this needs to be updated to include more information. Ok for now.
                    // 
                    this.set("route.path", "book-results/advanced/");
                }
            }

            _handleRecentSearch() {
                console.log("successfull");
            }

        } window.customElements.define(fragAdvancedSearch.is, fragAdvancedSearch);
    </script>
</dom-module>